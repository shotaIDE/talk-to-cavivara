# カヴィヴァラ応援課金機能の要件定義書

## 概要

ユーザーがカヴィヴァラさんたちを「応援する」という体で、金銭的なサポート（投げ銭・寄付）を行える機能を提供する。これは、アプリの基本機能は無料のまま維持しつつ、ユーザーの感謝の気持ちを表現する手段として位置付けられる。

## 背景

現在、アプリは完全無料で提供されており、課金機能は実装されていない。しかし、以下の理由から、応援課金の仕組みが必要である:

- 継続的な開発・運営コスト（サーバー費用、AI API費用など）をサポートする仕組みが必要
- 機能的な対価ではなく、純粋に「応援したい」という気持ちを表現したいユーザーのニーズがある
- カヴィヴァラキャラクターへの愛着を行動に移す場が求められている
- 無料アプリを維持しつつ、収益化の道を確保したい

「カヴィヴァラを応援する」という表現を用いることで、課金に対する心理的なハードルを下げ、ポジティブな体験として提供する。機能制限による課金ではなく、純粋な応援としての課金モデルを採用することで、ユーザーとの良好な関係を維持する。

## ユーザーストーリー

### 応援の気持ちを金銭的に表現したい

ユーザーとして、カヴィヴァラさんたちへの感謝や応援の気持ちを金銭的なサポートとして表現したい。なぜならば、良いサービスを提供してくれる開発者やキャラクターを支援することで、継続的な運営を後押しできるからだ。

受入基準:

- 複数の金額プランから選択できる（例: ¥120, ¥370, ¥610, ¥1,220, ¥3,060, ¥6,100など）
- プラン名は「カヴィヴァラを応援する」というポジティブな表現を使用
- 各金額に応じた「応援レベル」やメッセージが表示される
- 課金は都度課金（消費型）として実装される
- 全てのユーザーが応援課金可能（アプリの基本機能は無料のまま）

### 応援した履歴を確認したい

ユーザーとして、これまでにどれくらい応援したかを確認したい。なぜならば、自分の貢献度を可視化することで、コミュニティへの参加意識が高まるからだ。

受入基準:

- 応援画面に累計応援回数を表示
- 累計応援金額を表示（オプション）
- 「〇〇回応援してくれたヴィヴァ！」などの感謝メッセージが表示される
- 応援履歴はローカルまたはFirestoreに保存される

### 応援したことへの感謝を受け取りたい

ユーザーとして、応援した後にカヴィヴァラからの感謝メッセージを受け取りたい。なぜならば、応援が届いたことを実感でき、満足感が得られるからだ。

受入基準:

- 応援完了時に感謝のダイアログまたはスナックバーが表示される
- 「応援ありがとうヴィヴァ！」などのカヴィヴァラらしいメッセージ
- アニメーションやエフェクトで特別感を演出（オプション）
- ホーム画面に戻った際、カヴィヴァラが応援への感謝を述べる（オプション）

### 課金の目的を明確に理解したい

ユーザーとして、応援課金がどのように使われるかを理解したい。なぜならば、お金を払う価値があると納得した上で応援したいからだ。

受入基準:

- 応援画面に「応援金の使い道」が明記される
  - 例: 「サーバー運営費、新機能開発、カヴィヴァラの活動費に使われるヴィヴァ。」
- 透明性のある説明で信頼感を醸成
- 必要に応じて外部リンク（開発者のブログやサポートページなど）を提供

### 手軽に応援できる体験を求める

ユーザーとして、簡単な操作で素早く応援を完了したい。なぜならば、複雑な手続きは応援の気持ちを削ぐからだ。

受入基準:

- 最小タップ数で課金を完了できる（理想は2〜3タップ）
- 各プラットフォームのネイティブ課金UI（App Store / Google Play）を使用
- 課金処理中はローディング表示
- エラー発生時は分かりやすいメッセージを表示

### 課金しても機能が変わらないことを理解したい

ユーザーとして、応援課金が純粋なサポートであり、機能追加がないことを明確に理解したい。なぜならば、誤解なく納得した上で応援したいからだ。

受入基準:

- 応援画面に「応援課金では機能は追加されません」ことが明記される
- 「アプリの基本機能は引き続き無料でご利用いただけます」という説明
- 「あなたの応援が、今後の開発とサーバー運営を支えます」などの前向きなメッセージ
- 透明性のある説明で、ユーザーが安心して応援できる

### 応援したことで特別感を得たい（将来的な拡張）

開発者として、将来的には応援ユーザーに対して特別な体験を提供したい。なぜならば、継続的な支援を促進し、コミュニティの結束を強化できるからだ。

受入基準（将来的な実装候補）:

- 応援回数に応じたバッジやステータス表示
- 応援者限定のカヴィヴァラメッセージやアバター
- 応援ランキング（匿名化）の表示
- 応援者のみが参加できるイベントや先行機能体験

## UI 仕様

### 応援画面へのアクセス

応援画面は以下の場所からアクセス可能:

1. 設定画面の専用セクション
2. ドロワーメニューの専用アイテム（オプション）
3. チャット画面からのアクセス（オプション）

```
┌─────────────────────────────────────┐
│ 設定                            ← │
├─────────────────────────────────────┤
│ アカウント                          │
├─────────────────────────────────────┤
│ ...                                 │
├─────────────────────────────────────┤
│ アプリについて                      │
├─────────────────────────────────────┤
│ 💝  カヴィヴァラを応援              │
│     これまで3回応援            →   │
├─────────────────────────────────────┤
│ ...                                 │
└─────────────────────────────────────┘
```

- アイコン: 💝（ハートとリボン）
- タイトル: "カヴィヴァラを応援"
- サブタイトル: これまでの応援回数（例: "これまで3回応援"、未応援時は表示なし）
- タップで応援画面を表示

### 応援画面のレイアウト

```
┌─────────────────────────────────────┐
│ カヴィヴァラを応援              ← │
├─────────────────────────────────────┤
│                                     │
│           🎀                        │
│         ╱◠ ◠╲                      │
│        │・ω・│カヴィヴァラ          │
│         ╲   ╱                       │
│          ━━━                        │
│                                     │
│   いつも使ってくれてありがとう      │
│          ヴィヴァ！                 │
│                                     │
│   あなたの応援が、カヴィヴァラの    │
│   活動とアプリ開発を支えます。      │
│                                     │
│   💡 応援金の使い道                 │
│   ・サーバー運営費                  │
│   ・新機能開発                      │
│   ・カヴィヴァラの活動費            │
│                                     │
├─────────────────────────────────────┤
│                                     │
│   これまで 5回 応援してくれたヴィヴァ│
│                                     │
├─────────────────────────────────────┤
│  応援プランを選ぶ                   │
├─────────────────────────────────────┤
│  🌟 ちょっと応援      ¥120         │
│     「頑張って！」                  │
├─────────────────────────────────────┤
│  🌟🌟 しっかり応援    ¥370         │
│     「いつもありがとう！」          │
├─────────────────────────────────────┤
│  🌟🌟🌟 たっぷり応援  ¥610         │
│     「これからも応援するヴィヴァ！」│
├─────────────────────────────────────┤
│  💎 めっちゃ応援      ¥1,220       │
│     「大好きヴィヴァ！」            │
├─────────────────────────────────────┤
│  💎💎 超応援          ¥3,060       │
│     「全力で支援するヴィヴァ！」    │
├─────────────────────────────────────┤
│  💎💎💎 最強応援      ¥6,100       │
│     「ずっと一緒ヴィヴァ！」        │
├─────────────────────────────────────┤
│                                     │
│  ⓘ 応援課金では機能は追加されませ  │
│    んが、アプリの継続的な開発と    │
│    運営を支援できます。            │
│    基本機能は引き続き無料で        │
│    ご利用いただけます。            │
│                                     │
└─────────────────────────────────────┘
```

### 応援完了ダイアログ

```
┌─────────────────────────────────────┐
│         🎉                          │
│                                     │
│   応援ありがとうヴィヴァ！          │
│                                     │
│   あなたの気持ち、しっかり受け取っ  │
│   たヴィヴァ。これからも一緒に頑張  │
│   るヴィヴァ！                      │
│                                     │
│   [    閉じる    ]                 │
│                                     │
└─────────────────────────────────────┘
```

### 応援プラン一覧

| プラン名           | 金額    | アイコン | メッセージ                       |
| ------------------ | ------- | -------- | -------------------------------- |
| ちょっと応援       | ¥120    | 🌟       | 「頑張って！」                   |
| しっかり応援       | ¥370    | 🌟🌟     | 「いつもありがとう！」           |
| たっぷり応援       | ¥610    | 🌟🌟🌟   | 「これからも応援するヴィヴァ！」 |
| めっちゃ応援       | ¥1,220  | 💎       | 「大好きヴィヴァ！」             |
| 超応援             | ¥3,060  | 💎💎     | 「全力で支援するヴィヴァ！」     |
| 最強応援           | ¥6,100  | 💎💎💎   | 「ずっと一緒ヴィヴァ！」         |

※金額は日本円の例。各国の通貨に応じた価格設定が必要。

## 技術要件

### 課金システム

- **プラットフォーム課金API**:
  - iOS: StoreKit 2（in_app_purchase プラグイン使用）
  - Android: Google Play Billing Library（in_app_purchase プラグイン使用）
- **課金タイプ**: 非消費型アイテム（consumable）
  - 何度でも購入可能
  - 復元（リストア）不要
- **バックエンド検証**: Firebase Functions を使用して課金の正当性を検証（オプション、推奨）

### データモデル

#### SupportDonation（応援課金情報）

```dart
@freezed
class SupportDonation with _$SupportDonation {
  const factory SupportDonation({
    required String id,                // 課金ID
    required String userId,            // ユーザーID
    required String planId,            // プランID（例: 'support_120'）
    required String planName,          // プラン名（例: 'ちょっと応援'）
    required int amount,               // 金額（円）
    required DateTime timestamp,       // 課金日時
    required String platform,          // プラットフォーム（'ios' or 'android'）
    String? transactionId,             // トランザクションID
  }) = _SupportDonation;
}
```

#### SupportDonationStats（応援統計）

```dart
@freezed
class SupportDonationStats with _$SupportDonationStats {
  const factory SupportDonationStats({
    required int totalCount,           // 累計応援回数
    required int totalAmount,          // 累計応援金額（円）
    required DateTime? lastDonatedAt,  // 最終応援日時
  }) = _SupportDonationStats;
}
```

### リポジトリ

- `SupportDonationRepository`: 応援履歴の保存・取得
  - Firestore または SharedPreferences を使用
  - ユーザーごとの応援履歴を管理

### サービス

- `SupportDonationService`: 課金処理の実行
  - in_app_purchase プラグインを使用
  - 課金フローの管理（購入開始、検証、完了）
  - エラーハンドリング

### プロダクトID命名規則

App Store Connect / Google Play Console に登録するプロダクトID:

- `jp.co.sazanami_industrial.talk_to_cavivara.support_120`
- `jp.co.sazanami_industrial.talk_to_cavivara.support_370`
- `jp.co.sazanami_industrial.talk_to_cavivara.support_610`
- `jp.co.sazanami_industrial.talk_to_cavivara.support_1220`
- `jp.co.sazanami_industrial.talk_to_cavivara.support_3060`
- `jp.co.sazanami_industrial.talk_to_cavivara.support_6100`

※実際のアプリのバンドルID/パッケージ名に合わせて調整が必要

## 制約事項

- 応援課金では機能は追加されない（純粋なサポート）
- アプリの基本機能は全て無料のまま提供される
- 課金履歴は各プラットフォームの課金システムで管理
- ユーザーデータとして応援回数・金額をローカルまたはFirestoreに保存
- App Store / Google Play のガイドラインに準拠した実装が必要
  - 「寄付」「投げ銭」という表現は避け、「応援」という表現を使用
  - 課金なしでも全ての機能が利用可能であることを明示
  - ユーザーに誤解を与えないよう、機能追加がないことを明確に説明

## セキュリティとプライバシー

- 課金処理は各プラットフォームのネイティブAPIを使用し、安全性を確保
- バックエンド検証を実装し、不正な課金を防止（推奨）
- 個人情報（課金履歴）は適切に保護し、第三者に共有しない
- ユーザーの応援履歴は匿名化してアナリティクスで分析可能（オプション）

## 受入テスト

### 機能的な確認

- [ ] 応援画面が設定画面からアクセスできる
- [ ] 6つの応援プランが表示される
- [ ] 各プランをタップすると課金フローが開始される
- [ ] 課金が成功すると感謝メッセージが表示される
- [ ] 課金失敗時に適切なエラーメッセージが表示される
- [ ] 課金キャンセル時にメッセージが表示される
- [ ] 累計応援回数が正しく表示される
- [ ] アプリ再起動後も応援履歴が保持される

### プラットフォーム横断

- [ ] iOS の StoreKit で正しく課金できる
- [ ] Android の Google Play Billing で正しく課金できる
- [ ] サンドボックス環境でテストが完了している
- [ ] 本番環境で少なくとも1回の課金テストが成功している

### UI/UX の確認

- [ ] 応援画面のレイアウトが仕様通りである
- [ ] 各プランのアイコンとメッセージが正しく表示される
- [ ] 感謝ダイアログのメッセージが表示される
- [ ] 「機能追加がない」ことの説明が明記されている
- [ ] 「基本機能は無料」であることの説明が明記されている
- [ ] ローディング表示が適切に動作する

### エラーハンドリング

- [ ] ネットワークエラー時に適切なメッセージが表示される
- [ ] 課金システムエラー時に適切なメッセージが表示される
- [ ] ユーザーキャンセル時に適切なメッセージが表示される
- [ ] 未サインイン状態での挙動が適切である

### コード品質

- [ ] 単体テストが全て通過する
- [ ] コーディング規約に準拠している
- [ ] フォーマッターとリンターが通過する
- [ ] 必要なドキュメントが更新されている

## マイルストーン

### フェーズ1: 基本実装

- データモデルの定義
- 課金サービスの実装
- 応援画面のUI実装
- 課金フローの実装
- ローカル履歴保存の実装

### フェーズ2: バックエンド連携（オプション）

- Firestore への履歴保存
- Firebase Functions での検証
- アナリティクス連携

### フェーズ3: UX向上（将来的な拡張）

- 応援バッジ・ステータス機能
- 応援者限定コンテンツ
- 応援ランキング
- カヴィヴァラからの特別メッセージ

## 関連ドキュメント

- [技術設計書: カヴィヴァラ応援課金機能](../design/support-cavivara-donation.md)（作成予定）
- [App Store Review Guidelines - 3.1 Payments](https://developer.apple.com/app-store/review/guidelines/#payments)
- [Google Play Billing Guidelines](https://support.google.com/googleplay/android-developer/answer/140504)
- [in_app_purchase plugin documentation](https://pub.dev/packages/in_app_purchase)
