# 調整済吹き出しデザインの追加要件定義書

## 概要

チャット画面の吹き出しデザインに、新たに「調整済様式」スタイルを追加する。このデザインは、ツノを持たず、ツノが生える相当の部分をわずかに丸め(radius 2)、その他の部分は直線的に角を削る 7 角形のような形状とする。全体的に角は circular(2)程度で丸める。

## 背景

現在、以下の 2 つの吹き出しデザインが存在する:

- `corporateStandard` (社内標準様式): 全ての角が radius 8 で均一に丸められたデザイン
- `nextGeneration` (次世代様式): ツノが無く、メッセージの送信元を示す角(ツノ相当位置)が radius 2、他の角が radius 20 で丸められたデザイン

新たに追加する「調整済様式」デザインは、よりシャープで構造的な印象を与える形状を目指す。7 角形のような幾何学的な形状により、既存デザインとは異なる視覚的な特徴を持つ。

## ユーザーストーリー

### 幾何学的でシャープな吹き出しデザインを選択したい

ユーザーとして、既存の丸みを帯びたデザインに加え、よりシャープで構造的な印象の吹き出しデザインを選択したい。なぜならば、視覚的な好みは多様であり、よりエッジの効いたデザインを好むユーザーもいるからだ。

受入基準:

- 3 つ目のデザインとして「調整済様式」が選択可能である
- 調整済様式デザインは 7 角形のような形状を持つ
- ツノは生えない
- ツノが生える相当の部分(メッセージ送信元を示す角)は radius 2 で小さく丸められる
- それ以外の部分は直線的に角を削った形状である
- 全体的な角の丸みは radius 2 程度である

### 吹き出しの送信元を視覚的に識別したい

ユーザーとして、調整済様式デザインにおいても、ユーザーメッセージと AI メッセージを視覚的に区別したい。なぜならば、会話の流れを直感的に理解できるからだ。

受入基準:

- ユーザーメッセージ: 右上の角(ツノ相当位置)が radius 2 で小さく丸められる
- AI メッセージ: 左上の角(ツノ相当位置)が radius 2 で小さく丸められる
- システムメッセージ: 対称的な形状で表示される
- ツノ相当位置の角により、メッセージの送信元が視覚的に示される

### 既存のデザイン選択機能との整合性を期待する

ユーザーとして、既存のデザイン選択機能に新しいデザインがシームレスに追加されることを期待する。なぜならば、混乱なく新しいデザインを試すことができるからだ。

受入基準:

- デザイン選択ダイアログに 3 つ目の選択肢として表示される
- 選択したデザインは永続化される
- 既存の「社内標準様式」「次世代様式」の動作は変更されない
- デザイン選択ダイアログのプレビューで新しいデザインを確認できる

### プレビューで実際の見た目を確認したい

ユーザーとして、調整済様式デザインを選択する前にプレビューで確認したい。なぜならば、実際にどう見えるかを理解した上で選択できるからだ。

受入基準:

- 選択ダイアログに各デザインの吹き出しサンプルが表示される
- プレビューは実際のチャット画面の吹き出しと同じ見た目である
- 調整済様式デザインの幾何学的な形状がプレビューで確認できる

## 技術仕様

### 調整済様式デザインの形状仕様

#### ユーザーメッセージの吹き出し

```
右寄せ配置

       r2 ╱───────────╲ r2  ← ツノ相当位置(小さく丸める)
         │ メッセージ   │
       r2 ╲───────────╱ r2
```

- 左上: Radius.circular(2) (通常の角)
- 右上: Radius.circular(2) (ツノ相当位置、小さく丸める)
- 右下: Radius.circular(2) (通常の角)
- 左下: Radius.circular(2) (通常の角)

形状の特徴:

- ツノは生えない
- 右上の角(ツノ相当位置)を小さく丸めることで、視覚的な方向性を示す
- その他の角も同様に radius 2 で丸める
- 全体として 7 角形のようなシャープな印象

#### AI メッセージの吹き出し

```
左寄せ配置

r2 ╱───────────╲ r2  ← ツノ相当位置(小さく丸める)
   │ メッセージ   │
r2 ╲───────────╱ r2
```

- 左上: Radius.circular(2) (ツノ相当位置、小さく丸める)
- 右上: Radius.circular(2) (通常の角)
- 右下: Radius.circular(2) (通常の角)
- 左下: Radius.circular(2) (通常の角)

形状の特徴:

- ツノは生えない
- 左上の角(ツノ相当位置)を小さく丸めることで、視覚的な方向性を示す
- その他の角も同様に radius 2 で丸める
- 全体として 7 角形のようなシャープな印象

#### システムメッセージの吹き出し

```
中央配置

r2 ╱───────────╲ r2
   │ メッセージ   │
r2 ╲───────────╱ r2
```

- 全ての角: Radius.circular(2) (対称的なデザイン)

形状の特徴:

- 完全に対称的な形状
- 全ての角が radius 2 で均一に丸められる

### enum 定義の追加

`ChatBubbleDesign` enum に新しい値を追加:

```dart
enum ChatBubbleDesign {
  corporateStandard,  // 社内標準様式
  nextGeneration,     // 次世代様式
  harmonized,         // 調整済様式 (新規追加)
}
```

### 表示名の定義

- enum 値: `harmonized`
- 表示名: 「調整済様式」

### 実装対象ファイル

1. `client/lib/data/model/chat_bubble_design.dart`

   - `ChatBubbleDesign` enum に`harmonized`を追加

2. `client/lib/ui/component/chat_bubble_design_extension.dart`

   - `borderRadiusForMessageType`メソッドに`harmonized`のケースを追加
   - `displayName`プロパティに「調整済様式」を追加

3. `client/lib/ui/feature/settings/chat_bubble_design_selection_dialog.dart`

   - 選択肢に「調整済様式」を追加
   - プレビュー表示を追加

4. `client/test/ui/component/chat_bubble_design_extension_test.dart`
   - `harmonized`デザインのテストケースを追加

### 後方互換性

- 既存の`corporateStandard`と`nextGeneration`の動作は変更しない
- 既存のユーザー設定は引き続き有効
- デフォルト値は変更しない

### データ永続化

- `SharedPreferences`を使用した既存の永続化機構をそのまま利用
- 新しい enum 値`harmonized`も自動的に保存・復元される

## UI 仕様

### デザイン選択ダイアログ

```
┌─────────────────────────────────────┐
│ 吹き出しデザインの選択              │
├─────────────────────────────────────┤
│ ○ 社内標準様式                      │
│   ╭─────────╮                       │
│   │ サンプル │ (角が均一に丸い)     │
│   ╰─────────╯                       │
│                                     │
│ ○ 次世代様式                        │
│   ╭─────────╮                       │
│   │ サンプル │ (片隅が小さく丸い)   │
│   ╰────────╯                        │
│                                     │
│ ● 調整済様式                        │
│   ╱─────────╲                       │
│   │ サンプル │ (7角形のような形)    │
│   ╲─────────╱                       │
├─────────────────────────────────────┤
│                 キャンセル    OK   │
└─────────────────────────────────────┘
```

- ラジオボタンで選択(単一選択)
- 各選択肢にプレビュー用の吹き出しサンプルを表示
- 「調整済様式」のプレビューは 7 角形のような形状を反映
- 「キャンセル」ボタン: 変更を破棄してダイアログを閉じる
- 「OK」ボタン: 選択を確定して保存

### 設定画面

```
┌─────────────────────────────────────┐
│ 設定                            ← │
├─────────────────────────────────────┤
│ ... (既存の設定項目)                │
├─────────────────────────────────────┤
│ 表示設定                            │
├─────────────────────────────────────┤
│ 💬  吹き出しデザイン                │
│     調整済様式                 →   │
├─────────────────────────────────────┤
│ ... (その他の設定項目)              │
└─────────────────────────────────────┘
```

- サブタイトル部分に現在選択されているデザイン名を表示
- タップでデザイン選択ダイアログを表示

## デザインの意図

### 視覚的特徴

- **シャープさ**: 全ての角が radius 2 と小さいため、シャープでエッジの効いた印象
- **幾何学的**: 7 角形のような形状により、構造的で現代的な印象
- **方向性の示唆**: ツノ相当位置の角により、メッセージの送信元を視覚的に示す
- **ミニマル**: ツノがないため、すっきりとしたミニマルなデザイン

### 既存デザインとの差別化

| デザイン         | 特徴                   | 角の丸み                            |
| ---------------- | ---------------------- | ----------------------------------- |
| 社内標準様式     | 均一で柔らかい印象     | 全て radius 8                       |
| 次世代様式       | 丸みが強く親しみやすい | 大部分 radius 20、ツノ相当 radius 2 |
| 調整済様式(新) | シャープで幾何学的     | 全て radius 2                       |

## 制約事項

- iOS、Android 両プラットフォームで同一の見た目を保証する
- 既存のデザイン選択機能との互換性を維持する
- Flutter の`BorderRadius`クラスの機能範囲内で実装する
- ツノ(tail)は実装しない

## 受入テスト

### 視覚的な確認

- [ ] ユーザーメッセージの全ての角が radius 2 で表示される
- [ ] AI メッセージの全ての角が radius 2 で表示される
- [ ] システムメッセージの全ての角が radius 2 で表示される
- [ ] 7 角形のようなシャープな形状が表示される
- [ ] ツノが表示されない
- [ ] デザイン選択ダイアログのプレビューが正しく表示される

### 機能的な確認

- [ ] 「調整済様式」が選択可能である
- [ ] 「調整済様式」を選択すると新しいデザインが適用される
- [ ] デザイン選択が永続化される
- [ ] アプリ再起動後も選択したデザインが保持される
- [ ] 既存の「社内標準様式」「次世代様式」は変更されていない

### プラットフォーム横断

- [ ] iOS で正しく表示される
- [ ] Android で正しく表示される
- [ ] iOS/Android 間で見た目の差異がない

### テストコードの確認

- [ ] 単体テストが全て通過する
- [ ] ウィジェットテストが全て通過する
- [ ] `harmonized`デザインのテストケースが追加されている

## 関連ドキュメント

- [要件定義書: チャット吹き出しデザイン切り替え](./switch-design.md)
- [要件定義書: 吹き出しのツノ排除と角丸デザイン](./bubble-tail-removal.md)
- [技術設計書: チャット吹き出しデザイン切り替え](../design/switch-design-feature.md)
- [SharedPreferences 使用時の設計方法](../how-to-design-when-using-shared-preferences.md)
