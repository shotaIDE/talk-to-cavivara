# 調整済吹き出しデザインの追加要件定義書

## 概要

チャット画面の吹き出しデザインに、新たに「調整済様式」スタイルを追加する。このデザインは、ツノを持たず、3隅の角を二等辺三角形（等辺10pt）の形で削り取った7角形の形状とする。メッセージの送信元を示す1つの角は削らずに残し、視覚的な方向性を示す。

## 背景

現在、以下の 2 つの吹き出しデザインが存在する:

- `corporateStandard` (社内標準様式): 全ての角が radius 8 で均一に丸められたデザイン
- `nextGeneration` (次世代様式): ツノが無く、メッセージの送信元を示す角(ツノ相当位置)が radius 2、他の角が radius 20 で丸められたデザイン

新たに追加する「調整済様式」デザインは、よりシャープで構造的な印象を与える形状を目指す。3隅の角を二等辺三角形で削り取った7角形という幾何学的な形状により、既存デザインとは異なる明確な視覚的特徴を持つ。

## ユーザーストーリー

### 幾何学的でシャープな吹き出しデザインを選択したい

ユーザーとして、既存の丸みを帯びたデザインに加え、よりシャープで構造的な印象の吹き出しデザインを選択したい。なぜならば、視覚的な好みは多様であり、よりエッジの効いたデザインを好むユーザーもいるからだ。

受入基準:

- 3 つ目のデザインとして「調整済様式」が選択可能である
- 調整済様式デザインは正確に7角形の形状を持つ
- ツノは生えない
- メッセージ送信元を示す1つの角は削らずに残る
- それ以外の3隅の角は二等辺三角形（等辺10pt）の形で削り取られる
- 削り取られた部分は直線的なエッジを持つ

### 吹き出しの送信元を視覚的に識別したい

ユーザーとして、調整済様式デザインにおいても、ユーザーメッセージと AI メッセージを視覚的に区別したい。なぜならば、会話の流れを直感的に理解できるからだ。

受入基準:

- ユーザーメッセージ: 左上の角のみ残り、右上・右下・左下の3隅が削られる
- AI メッセージ: 右上の角のみ残り、左上・右下・左下の3隅が削られる
- システムメッセージ: 上下対称な形状で、4隅全てが削られる（左右の角が残る）
- 残された角により、メッセージの送信元が視覚的に示される

### 既存のデザイン選択機能との整合性を期待する

ユーザーとして、既存のデザイン選択機能に新しいデザインがシームレスに追加されることを期待する。なぜならば、混乱なく新しいデザインを試すことができるからだ。

受入基準:

- デザイン選択ダイアログに 3 つ目の選択肢として表示される
- 選択したデザインは永続化される
- 既存の「社内標準様式」「次世代様式」の動作は変更されない
- デザイン選択ダイアログのプレビューで新しいデザインを確認できる

### プレビューで実際の見た目を確認したい

ユーザーとして、調整済様式デザインを選択する前にプレビューで確認したい。なぜならば、実際にどう見えるかを理解した上で選択できるからだ。

受入基準:

- 選択ダイアログに各デザインの吹き出しサンプルが表示される
- プレビューは実際のチャット画面の吹き出しと同じ見た目である
- 調整済様式デザインの幾何学的な形状がプレビューで確認できる

## 技術仕様

### 調整済様式デザインの形状仕様

#### ユーザーメッセージの吹き出し

```
右寄せ配置

    ┌────────────╲
    │ メッセージ   ╲
    │              │
    ╲──────────────╱
```

7角形の形状:

- 左上: 残す（90度の角、メッセージ送信元を示す）
- 右上: 二等辺三角形（等辺10pt）で削る
- 右下: 二等辺三角形（等辺10pt）で削る
- 左下: 二等辺三角形（等辺10pt）で削る

形状の特徴:

- ツノは生えない
- 左上の角のみ残すことで、ユーザー発信であることを視覚的に示す
- 3隅を二等辺三角形で削ることで、7角形の幾何学的な形状を実現
- 削り取られた辺は直線的で、シャープな印象

#### AI メッセージの吹き出し

```
左寄せ配置

╱────────────┐
╱ メッセージ   │
│              │
╲──────────────╱
```

7角形の形状:

- 左上: 二等辺三角形（等辺10pt）で削る
- 右上: 残す（90度の角、メッセージ送信元を示す）
- 右下: 二等辺三角形（等辺10pt）で削る
- 左下: 二等辺三角形（等辺10pt）で削る

形状の特徴:

- ツノは生えない
- 右上の角のみ残すことで、AI発信であることを視覚的に示す
- 3隅を二等辺三角形で削ることで、7角形の幾何学的な形状を実現
- 削り取られた辺は直線的で、シャープな印象

#### システムメッセージの吹き出し

```
中央配置

╱────────────╲
│ メッセージ   │
╲────────────╱
```

6角形の形状（上下対称）:

- 左上: 二等辺三角形（等辺10pt）で削る
- 右上: 二等辺三角形（等辺10pt）で削る
- 右下: 二等辺三角形（等辺10pt）で削る
- 左下: 二等辺三角形（等辺10pt）で削る
- 左右の中央: 角として残る

形状の特徴:

- 完全に上下対称な6角形
- 4隅全てを削ることで、中立的な印象を与える

### enum 定義の追加

`ChatBubbleDesign` enum に新しい値を追加:

```dart
enum ChatBubbleDesign {
  corporateStandard,  // 社内標準様式
  nextGeneration,     // 次世代様式
  harmonized,         // 調整済様式 (新規追加)
}
```

### 表示名の定義

- enum 値: `harmonized`
- 表示名: 「調整済様式」

### 実装対象ファイル

1. `client/lib/data/model/chat_bubble_design.dart`

   - `ChatBubbleDesign` enum に`harmonized`を追加

2. `client/lib/ui/component/harmonized_bubble_clipper.dart` **【新規作成】**

   - `CustomClipper<Path>` を実装
   - 7角形（または6角形）のパスを生成
   - メッセージタイプに応じて削る角を変更

3. `client/lib/ui/component/chat_bubble_design_extension.dart`

   - `displayName`プロパティに「調整済様式」を追加
   - 注: `borderRadiusForMessageType` は `harmonized` の場合は使用しない

4. `client/lib/ui/feature/home/home_screen.dart`

   - 各吹き出しウィジェットで `harmonized` の場合に `ClipPath` を使用
   - `HarmonizedBubbleClipper` を適用

5. `client/lib/ui/feature/settings/chat_bubble_design_selection_dialog.dart`

   - 選択肢に「調整済様式」を追加
   - プレビュー表示を追加（7角形の形状を反映）

6. `client/test/ui/component/harmonized_bubble_clipper_test.dart` **【新規作成】**

   - `HarmonizedBubbleClipper`のテストケースを追加

7. `client/test/ui/component/chat_bubble_design_extension_test.dart`
   - `harmonized`デザインのテストケースを追加

### 後方互換性

- 既存の`corporateStandard`と`nextGeneration`の動作は変更しない
- 既存のユーザー設定は引き続き有効
- デフォルト値は変更しない

### データ永続化

- `SharedPreferences`を使用した既存の永続化機構をそのまま利用
- 新しい enum 値`harmonized`も自動的に保存・復元される

## UI 仕様

### デザイン選択ダイアログ

```
┌─────────────────────────────────────┐
│ 吹き出しデザインの選択              │
├─────────────────────────────────────┤
│ ○ 社内標準様式                      │
│   ╭─────────╮                       │
│   │ サンプル │ (角が均一に丸い)     │
│   ╰─────────╯                       │
│                                     │
│ ○ 次世代様式                        │
│   ╭─────────╮                       │
│   │ サンプル │ (片隅が小さく丸い)   │
│   ╰────────╯                        │
│                                     │
│ ● 調整済様式                        │
│   ╱─────────╲                       │
│   │ サンプル │ (7角形のような形)    │
│   ╲─────────╱                       │
├─────────────────────────────────────┤
│                 キャンセル    OK   │
└─────────────────────────────────────┘
```

- ラジオボタンで選択(単一選択)
- 各選択肢にプレビュー用の吹き出しサンプルを表示
- 「調整済様式」のプレビューは 7 角形のような形状を反映
- 「キャンセル」ボタン: 変更を破棄してダイアログを閉じる
- 「OK」ボタン: 選択を確定して保存

### 設定画面

```
┌─────────────────────────────────────┐
│ 設定                            ← │
├─────────────────────────────────────┤
│ ... (既存の設定項目)                │
├─────────────────────────────────────┤
│ 表示設定                            │
├─────────────────────────────────────┤
│ 💬  吹き出しデザイン                │
│     調整済様式                 →   │
├─────────────────────────────────────┤
│ ... (その他の設定項目)              │
└─────────────────────────────────────┘
```

- サブタイトル部分に現在選択されているデザイン名を表示
- タップでデザイン選択ダイアログを表示

## デザインの意図

### 視覚的特徴

- **シャープさ**: 角を二等辺三角形で削り取ることで、直線的でシャープな印象
- **幾何学的**: 正確な7角形（システムメッセージは6角形）という明確な幾何学的形状
- **方向性の明示**: 残された角により、メッセージの送信元を明確に視覚的に示す
- **ミニマル**: ツノがなく、単純な多角形であるため、すっきりとしたミニマルなデザイン
- **独自性**: 既存の丸みを帯びたデザインとは全く異なる、角張った独特のスタイル

### 既存デザインとの差別化

| デザイン         | 特徴                   | 形状                                    | 実装方法              |
| ---------------- | ---------------------- | --------------------------------------- | --------------------- |
| 社内標準様式     | 均一で柔らかい印象     | 角が radius 8 で丸められた四角形        | BorderRadius          |
| 次世代様式       | 丸みが強く親しみやすい | 角が radius 20/2 で丸められた四角形     | BorderRadius          |
| 調整済様式(新) | シャープで幾何学的     | 3隅を削った7角形（6角形）               | CustomClipper + Path  |

## 制約事項

- iOS、Android 両プラットフォームで同一の見た目を保証する
- 既存のデザイン選択機能との互換性を維持する
- Flutter の`CustomClipper`と`Path`クラスを使用して実装する
- ツノ(tail)は実装しない
- 二等辺三角形の等辺は正確に10ptとする
- 削り取られた辺は直線とする（曲線は使用しない）

## 受入テスト

### 視覚的な確認

- [ ] ユーザーメッセージが7角形で表示される（左上の角のみ残る）
- [ ] AI メッセージが7角形で表示される（右上の角のみ残る）
- [ ] システムメッセージが6角形で表示される（左右の角が残る）
- [ ] 削り取られた部分が二等辺三角形（等辺10pt）の形状である
- [ ] 削り取られた辺が直線的である
- [ ] 残された角が90度の角として表示される
- [ ] ツノが表示されない
- [ ] デザイン選択ダイアログのプレビューが正しく表示される

### 機能的な確認

- [ ] 「調整済様式」が選択可能である
- [ ] 「調整済様式」を選択すると新しいデザインが適用される
- [ ] デザイン選択が永続化される
- [ ] アプリ再起動後も選択したデザインが保持される
- [ ] 既存の「社内標準様式」「次世代様式」は変更されていない

### プラットフォーム横断

- [ ] iOS で正しく表示される
- [ ] Android で正しく表示される
- [ ] iOS/Android 間で見た目の差異がない

### テストコードの確認

- [ ] 単体テストが全て通過する
- [ ] ウィジェットテストが全て通過する
- [ ] `harmonized`デザインのテストケースが追加されている

## 関連ドキュメント

- [要件定義書: チャット吹き出しデザイン切り替え](./switch-design.md)
- [要件定義書: 吹き出しのツノ排除と角丸デザイン](./bubble-tail-removal.md)
- [技術設計書: チャット吹き出しデザイン切り替え](../design/switch-design-feature.md)
- [SharedPreferences 使用時の設計方法](../how-to-design-when-using-shared-preferences.md)
